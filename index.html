<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fly's Diary</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400;500;600&family=Lora:wght@400;500;600&family=Roboto:wght@300;400;500&display=swap');

        :root {
            --bg-color: #fafafa;
            --text-color: #111;
            --card-bg: white;
            --shadow-color: rgba(0,0,0,0.1);
            --border-color: #ddd;
            --button-hover: #f5f5f5;
            --accent-color: #2563eb;
            --danger-color: #dc2626;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --sidebar-width: 250px;
            --header-height: 64px;
            --font-family: 'Inter', sans-serif;
            --font-size: 16px;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --card-bg: #2d2d2d;
            --shadow-color: rgba(0,0,0,0.3);
            --border-color: #404040;
            --button-hover: #3d3d3d;
            --accent-color: #60a5fa;
            --danger-color: #ef4444;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --info-color: #60a5fa;
        }

        - {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
            font-size: var(--font-size);
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom background styles */
        body.custom-bg-image {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body.custom-bg-pattern {
            background-repeat: repeat;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: -1;
            display: none;
        }

        body.custom-bg-image .bg-overlay {
            display: block;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed);
            z-index: 990;
            overflow-y: auto;
            box-shadow: 2px 0 10px var(--shadow-color);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
                        font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-color);
        }

        .sidebar-close {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .sidebar-content {
            padding: 1rem 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #888;
            letter-spacing: 1px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            color: var(--text-color);
            text-decoration: none;
        }

        .sidebar-menu-item:hover {
            background-color: var(--button-hover);
        }

        .sidebar-menu-item.active {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
        }

        .sidebar-menu-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex-grow: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed);
        }

        .header {
            height: var(--header-height);
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 980;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
            margin-right: 1rem;
            display: none;
        }

        .page-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-bar {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.2);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .content {
            padding: 2rem;
        }

        

        /* Diary Entries */
        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .view-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .view-toggle-btn {
            background: none;
            border: none;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .view-toggle-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .entries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .entry-card {
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .entry-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .entry-card-inner {
            padding: 1.5rem;
        }

        .entry-card.has-background {
            color: white;
        }

        .entry-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        .entry-card.has-background .entry-card-inner {
            position: relative;
            z-index: 2;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .entry-date {
            font-size: 0.875rem;
            color: #888;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entry-card.has-background .entry-date {
            color: rgba(255, 255, 255, 0.8);
        }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .entry-card:hover .entry-actions {
            opacity: 1;
        }

        .entry-action-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .entry-card.has-background .entry-action-btn {
            color: white;
        }

        .entry-action-btn:hover {
            background: var(--button-hover);
        }

        .entry-card.has-background .entry-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .entry-action-btn.delete:hover {
            color: var(--danger-color);
        }

        .entry-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-color);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entry-card.has-background .entry-content {
            color: white;
        }

        .entry-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .entry-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .entry-tag {
            background: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .entry-card.has-background .entry-tag {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .entry-indicators {
            display: flex;
            gap: 0.75rem;
        }

        .entry-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #888;
            font-size: 0.875rem;
        }

        .entry-card.has-background .entry-indicator {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Entry Detail View */
        .entry-detail {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .entry-detail-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .entry-detail-title {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .entry-detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            color: #888;
            font-size: 0.875rem;
        }

        .entry-detail-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entry-detail-actions {
            display: flex;
            gap: 0.75rem;
        }

        .entry-detail-action {
            padding: 0.5rem;
            background: var(--button-hover);
            border: none;
            border-radius: 5px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .entry-detail-action:hover {
            background: var(--border-color);
        }

        .entry-detail-action.danger {
            color: var(--danger-color);
        }

        .entry-detail-action.danger:hover {
            background: rgba(var(--danger-color-rgb), 0.1);
        }

        .entry-detail-content {
            padding: 2rem;
        }

        .entry-detail-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            white-space: pre-wrap;
        }

        .entry-media-section {
            margin-top: 2rem;
        }

        .entry-media-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entry-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .entry-image {
            border-radius: 5px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            position: relative;
        }

        .entry-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .entry-image:hover img {
            transform: scale(1.05);
        }

        .entry-image-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .entry-image:hover .entry-image-actions {
            opacity: 1;
        }

        .entry-image-action {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
                        cursor: pointer;
            transition: background-color 0.3s;
        }

        .entry-image-action:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .entry-voice-notes {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .voice-note {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .voice-note-play {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-note-play:hover {
            transform: scale(1.1);
        }

        .voice-note-info {
            flex-grow: 1;
        }

        .voice-note-title {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .voice-note-duration {
            font-size: 0.75rem;
            color: #888;
        }

        .voice-note-waveform {
            flex-grow: 1;
            height: 40px;
            background: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 4px;
        }

        .voice-note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .voice-note-action {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }

        .voice-note-action:hover {
            color: var(--accent-color);
        }

        .voice-note-action.delete:hover {
            color: var(--danger-color);
        }

        /* New Entry */
        .editor-container {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .editor-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .editor-actions {
            display: flex;
            gap: 1rem;
        }

        .editor-content {
            padding: 1.5rem;
        }

        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .editor-tool {
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .editor-tool:hover {
            background: var(--button-hover);
        }

        .editor-tool.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .editor-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .rich-editor {
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .rich-editor:focus-within {
            border-color: var(--accent-color);
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-color);
            min-height: 42px;
            align-items: center;
        }

        .tag-input-container:focus-within {
            border-color: var(--accent-color);
        }

        .tag-item {
            background: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .tag-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: var(--text-color);
            padding: 0.25rem;
            min-width: 100px;
        }

        .tag-input:focus {
            outline: none;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .tag-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tag-suggestion:hover {
            background: var(--button-hover);
        }

        .media-upload-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .media-upload-dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .media-upload-dropzone:hover, .media-upload-dropzone.active {
            border-color: var(--accent-color);
            background: rgba(var(--accent-color-rgb), 0.05);
        }

        .media-upload-icon {
            font-size: 2rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }

        .media-upload-text {
            margin-bottom: 0.5rem;
        }

        .media-upload-hint {
            font-size: 0.75rem;
            color: #888;
        }

        .media-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .media-preview-item {
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .media-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview-audio {
            background: rgba(var(--accent-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
        }

        .media-preview-audio-icon {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .media-preview-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .media-preview-remove:hover {
            background: rgba(var(--danger-color-rgb), 0.8);
        }

        .voice-recorder {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .voice-recorder-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5rem;
        }

        .voice-recorder-btn:hover {
            transform: scale(1.05);
        }

        .voice-recorder-btn.recording {
            background: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(var(--danger-color-rgb), 0.5);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(var(--danger-color-rgb), 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(var(--danger-color-rgb), 0);
            }
        }

        .voice-recorder-timer {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--danger-color);
        }

        .voice-recorder-status {
            flex-grow: 1;
            font-size: 0.875rem;
            color: #888;
        }

        .entry-customization {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        .background-option {
            width: 60px;
            height: 40px;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .background-option:hover {
            transform: scale(1.05);
        }

        .background-option.selected {
            border: 2px solid var(--accent-color);
        }

        /* Settings */
        .settings-section {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .settings-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .settings-content {
            padding: 1.5rem;
        }

        .settings-group {
            margin-bottom: 2rem;
        }

        .settings-group-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .settings-label {
            font-size: 0.875rem;
        }

        .theme-options {
            display: flex;
            gap: 1rem;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .theme-preview {
            width: 80px;
            height: 50px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .theme-preview-light {
            background: #fafafa;
        }

        .theme-preview-dark {
            background: #1a1a1a;
        }

        .theme-preview-inner {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .theme-preview-light .theme-preview-inner {
            background: white;
            border: 1px solid #ddd;
        }

        .theme-preview-dark .theme-preview-inner {
            background: #2d2d2d;
            border: 1px solid #404040;
        }

        .theme-option.selected .theme-preview {
            border: 2px solid var(--accent-color);
        }

        .font-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-color);
            color: var(--text-color);
            min-width: 200px;
        }

        .font-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .font-size-options {
                        display: flex;
            gap: 0.5rem;
        }

        .font-size-option {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .font-size-option:hover {
            background: var(--button-hover);
        }

        .font-size-option.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .color-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .custom-color-input {
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }

        .custom-bg-option {
            aspect-ratio: 16/9;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
        }

        .custom-bg-option:hover {
            transform: scale(1.05);
        }

        .custom-bg-option.selected {
            border: 2px solid var(--accent-color);
        }

        .custom-bg-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-bg-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
        }

        .custom-bg-upload-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            color: #888;
        }

        .custom-bg-upload-text {
            font-size: 0.75rem;
            color: #888;
            text-align: center;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-container {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow-color);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Image Viewer */
        .image-viewer-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .image-viewer-container.active {
            opacity: 1;
            pointer-events: all;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-viewer-img {
            max-width: 100%;
            max-height: 90vh;
            display: block;
            border-radius: 5px;
        }

        .image-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .image-viewer-close:hover {
            color: var(--danger-color);
        }

        .image-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.5rem;
        }

        .image-viewer-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .image-viewer-prev {
            left: 20px;
        }

        .image-viewer-next {
            right: 20px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--button-hover);
            color: var(--text-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: none;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(var(--accent-color-rgb), 0.1);
            transform: translateY(-2px);
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: var(--accent-color);
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 100;
            transition: all 0.3s;
        }

        .fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 16px var(--shadow-color);
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 350px;
        }

        .notification {
            padding: 1rem;
            border-radius: 5px;
            background: var(--card-bg);
            box-shadow: 0 5px 15px var(--shadow-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            animation: slide-in 0.3s forwards;
            transform: translateX(120%);
        }

        @keyframes slide-in {
            to {
                transform: translateX(0);
            }
        }

        .notification.closing {
            animation: slide-out 0.3s forwards;
        }

        @keyframes slide-out {
            to {
                transform: translateX(120%);
            }
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification-success .notification-icon {
            color: var(--success-color);
        }

        .notification-error .notification-icon {
            color: var(--danger-color);
        }

        .notification-warning .notification-icon {
            color: var(--warning-color);
        }

        .notification-info .notification-icon {
            color: var(--info-color);
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .notification-message {
            font-size: 0.875rem;
            color: #888;
        }

        .notification-close {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }

        .notification-close:hover {
            color: var(--danger-color);
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg-color);
            background-size: cover;
            background-position: center;
        }

        .auth-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            width: 90%;
            max-width: 400px;
            position: relative;
            z-index: 10;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .auth-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .auth-button {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 5px;
            background: var(--accent-color);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-button:hover {
            filter: brightness(1.1);
        }

        .auth-error {
            background: rgba(var(--danger-color-rgb), 0.1);
            color: var(--danger-color);
            padding: 1rem;
            border-radius: 5px;
            font-size: 0.875rem;
            display: none;
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(var(--accent-color-rgb), 0.1);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .sidebar-close {
                display: block;
            }

            .sidebar.active {
                transform: translateX(0);
                box-shadow: 2px 0 10px var(--shadow-color);
            }

            .search-bar {
                width: 200px;
            }
                        .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-actions {
                gap: 0.5rem;
            }

            .search-bar {
                width: 150px;
            }

            .content {
                padding: 1.5rem;
            }

            .entries-grid {
                grid-template-columns: 1fr;
            }

            .entries-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .filter-container {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .entry-detail-header {
                flex-direction: column;
                gap: 1rem;
            }

            .entry-detail-actions {
                align-self: flex-start;
            }

            .voice-recorder {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .voice-recorder-btn {
                align-self: center;
            }

            .voice-note {
                flex-wrap: wrap;
            }

            .modal-container {
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .content {
                padding: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .entry-card-inner {
                padding: 1rem;
            }

            .entry-detail-header,
            .entry-detail-content {
                padding: 1rem;
            }

            .editor-header,
            .editor-content {
                padding: 1rem;
            }

            .fab {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .notification-container {
                max-width: 300px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 1.5rem;
        }

        .mt-4 {
            margin-top: 2rem;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .mb-4 {
            margin-bottom: 2rem;
        }

        .w-100 {
            width: 100%;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-1 {
            gap: 0.5rem;
        }

        .gap-2 {
            gap: 1rem;
        }

        .gap-3 {
            gap: 1.5rem;
        }

        .text-success {
            color: var(--success-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .text-info {
            color: var(--info-color);
        }

        .text-accent {
            color: var(--accent-color);
        }

        .text-muted {
            color: #888;
        }

        .font-bold {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="bg-overlay"></div>
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-book-open fa-3x text-accent"></i>
            </div>
            <h2 class="auth-title">Fly's Diary</h2>
            <div id="authError" class="auth-error"></div>
            <form id="authForm" class="auth-form">
                <input type="password" class="auth-input" id="initialAuth" placeholder="Enter authentication code" required>
                <button type="submit" class="auth-button">Access Diary</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainContent" class="app-container hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Fly's Diary</div>
                <button id="sidebarClose" class="sidebar-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Main</div>
                    <ul class="sidebar-menu">
                        <li class="sidebar-menu-item" data-page="entries">
                            <i class="fas fa-book"></i> All Entries
                        </li>
                        <li class="sidebar-menu-item" data-page="new-entry">
                            <i class="fas fa-edit"></i> New Entry
                        </li>
                    </ul>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Organize</div>
                    <ul class="sidebar-menu">
                        <li class="sidebar-menu-item" data-page="tags">
                            <i class="fas fa-tags"></i> Tags
                        </li>
                        <li class="sidebar-menu-item" data-page="search">
                            <i class="fas fa-search"></i> Search
                        </li>
                    </ul>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Customize</div>
                    <ul class="sidebar-menu">
                        <li class="sidebar-menu-item" data-page="settings">
                            <i class="fas fa-cog"></i> Settings
                        </li>
                    </ul>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="visitor-count">
                    <i class="fas fa-eye"></i>
                    <span id="visitorCount">0</span> visits
                </div>
                <button id="themeToggle" class="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button id="menuToggle" class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">All entries</h1>
                </div>
                <div class="header-actions">
                    <div class="search-bar">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search entries..." id="quickSearch">
                    </div>
                </div>
            </header>

            <div id="appContent" class="content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>

        <!-- FAB Button -->
        <button id="newEntryFab" class="fab btn-icon">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modals -->
    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Authentication Required</h2>
                <button class="modal-close" onclick="closeModal('authModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="authModalError" class="auth-error mb-3"></div>
                <div class="form-group">
                    <label class="form-label">Enter Authentication Code</label>
                    <input type="password" id="authModalInput" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('authModal')">Cancel</button>
                <button id="authModalSubmit" class="btn btn-primary">Authenticate</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Deletion</h2>
                <button class="modal-close" onclick="closeModal('deleteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p>Are you sure you want to delete this entry? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button id="confirmDelete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer -->
    <div id="imageViewer" class="image-viewer-container">
        <div class="image-viewer-content">
            <button class="image-viewer-close" onclick="closeImageViewer()">
                <i class="fas fa-times"></i>
            </button>
            <button class="image-viewer-nav image-viewer-prev" onclick="prevImage()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <img id="viewerImage" class="image-viewer-img" src="" alt="Entry image">
            <button class="image-viewer-nav image-viewer-next" onclick="nextImage()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const API_URL = 'https://diary-3byr.onrender.com'; // Update with your actual API URL
        let authToken = localStorage.getItem('diaryAuthToken') || '';
        let currentPage = 'entries';
        let currentEntryId = null;
        let allEntries = [];
        let allTags = [];
        let currentImageIndex = 0;
        let imageGallery = [];
        let theme = localStorage.getItem('theme') || 'light';
        let appSettings = {
            theme: 'light',
            background_type: 'color',
            background_value: '#fafafa',
            font_family: 'Inter, sans-serif',
            font_size: 'medium',
            accent_color: '#2563eb'
        };
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingDuration = 0;
        let uploadedImages = [];
        let uploadedVoiceNotes = [];
        let currentEntry = null;

        // DOM Elements
        const mainContent = document.getElementById('mainContent');
        const authScreen = document.getElementById('authScreen');
        const sidebar = document.getElementById('sidebar');
        const appContent = document.getElementById('appContent');
        const pageTitle = document.getElementById('pageTitle');
        const menuToggle = document.getElementById('menuToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const themeToggle = document.getElementById('themeToggle');
        const visitorCount = document.getElementById('visitorCount');
        const newEntryFab = document.getElementById('newEntryFab');
        const quickSearch = document.getElementById('quickSearch');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notificationContainer = document.getElementById('notificationContainer');

        // Initial Setup
        document.addEventListener('DOMContentLoaded', async () => {
            setupTheme();
            setupEventListeners();
            
            // Check if user is already authenticated
            if (authToken) {
                try {
                    // Validate the token
                    const response = await fetch(`${API_URL}/auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ authCode: authToken })
                    });
                    
                    if (response.ok) {
                        // Auth token is valid
                        showApp();
                        loadPage(currentPage);
                        incrementVisitors();
                    } else {
                        // Auth token is invalid
                        localStorage.removeItem('diaryAuthToken');
                        authToken = '';
                        showAuthScreen();
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    showAuthScreen();
                }
            } else {
                showAuthScreen();
            }
        });

        // Setup Functions
        function setupTheme() {
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function setupEventListeners() {
            // Auth form submission
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.getAttribute('data-page');
                    loadPage(page);
                    
                    // Update active menu item
                    document.querySelectorAll('.sidebar-menu-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    item.classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Sidebar toggle
            menuToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
            });
            
            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
                        // New entry FAB
            newEntryFab.addEventListener('click', () => {
                loadPage('new-entry');
                
                // Update active menu item
                document.querySelectorAll('.sidebar-menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                document.querySelector('[data-page="new-entry"]').classList.add('active');
            });
            
            // Quick search
            quickSearch.addEventListener('input', (e) => {
                const searchText = e.target.value.toLowerCase();
                if (currentPage === 'entries' && searchText.length > 0) {
                    filterEntries(searchText);
                } else if (searchText.length === 0 && currentPage === 'entries') {
                    renderEntries(allEntries);
                }
            });
            
            // Auth modal submit
            document.getElementById('authModalSubmit').addEventListener('click', () => {
                const authCode = document.getElementById('authModalInput').value;
                if (authCode === authToken) {
                    closeModal('authModal');
                    return Promise.resolve();
                } else {
                    document.getElementById('authModalError').textContent = 'Invalid authentication code';
                    document.getElementById('authModalError').style.display = 'block';
                    return Promise.reject(new Error('Authentication failed'));
                }
            });
            
            // Confirm delete button
            document.getElementById('confirmDelete').addEventListener('click', async () => {
                if (currentEntryId) {
                    await deleteEntry(currentEntryId);
                    closeModal('deleteModal');
                    currentEntryId = null;
                }
            });
        }

        // Auth Functions
        async function handleAuth(e) {
            e.preventDefault();
            const authCode = document.getElementById('initialAuth').value;
            
            try {
                showLoading();
                const response = await fetch(`${API_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ authCode })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Authentication failed');
                }

                // Save auth token and show app
                authToken = authCode;
                localStorage.setItem('diaryAuthToken', authToken);
                showApp();
                loadPage(currentPage);
                incrementVisitors();
                
                // Clear auth form
                document.getElementById('initialAuth').value = '';
            } catch (error) {
                const authError = document.getElementById('authError');
                authError.textContent = error.message;
                authError.style.display = 'block';
                setTimeout(() => {
                    authError.style.display = 'none';
                }, 3000);
            } finally {
                hideLoading();
            }
        }

        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainContent.classList.add('hidden');
        }

        function showApp() {
            authScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }

        // API Functions
        async function fetchWithAuth(url, options = {}) {
            try {
                // Check if authentication is required
                if (!authToken) {
                    return new Promise((resolve, reject) => {
                        // Show auth modal
                        openModal('authModal');
                        
                        // Set up event listener for auth modal submit
                        const handleAuthModalSubmit = async () => {
                            try {
                                const authCode = document.getElementById('authModalInput').value;
                                if (!authCode) {
                                    throw new Error('Authentication code is required');
                                }
                                
                                const authResponse = await fetch(`${API_URL}/auth`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ authCode })
                                });
                                
                                if (!authResponse.ok) {
                                    throw new Error('Authentication failed');
                                }
                                
                                authToken = authCode;
                                localStorage.setItem('diaryAuthToken', authToken);
                                closeModal('authModal');
                                
                                // Now retry the original request
                                const finalOptions = {
                                    ...options,
                                    headers: {
                                        ...options.headers,
                                        'X-Auth-Code': authToken
                                    }
                                };
                                
                                const response = await fetch(`${API_URL}${url}`, finalOptions);
                                resolve(response);
                            } catch (error) {
                                document.getElementById('authModalError').textContent = error.message;
                                document.getElementById('authModalError').style.display = 'block';
                                reject(error);
                            }
                        };
                        
                        document.getElementById('authModalSubmit').addEventListener('click', handleAuthModalSubmit, { once: true });
                    });
                }
                
                // Add auth header
                const finalOptions = {
                    ...options,
                    headers: {
                        ...options.headers,
                        'X-Auth-Code': authToken
                    }
                };
                
                // Add timeout to fetch requests
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timed out')), 30000); // 30 second timeout
                });
                
                // Race between the fetch and the timeout
                const response = await Promise.race([
                    fetch(`${API_URL}${url}`, finalOptions),
                    timeoutPromise
                ]);
                
                // Check for unauthorized response
                if (response.status === 401) {
                    // Clear auth token and ask for re-authentication
                    authToken = '';
                    localStorage.removeItem('diaryAuthToken');
                    
                    // Recursive call to retry with authentication
                    return fetchWithAuth(url, options);
                }
                
                return response;
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                throw error;
            }
        }
        
        // Helper function to safely parse JSON
        function safeJSON(data) {
            try {
                return JSON.parse(data);
            } catch (e) {
                console.error('JSON parsing error:', e);
                return null;
            }
        }
        
        // Helper function to handle API errors
        async function handleApiResponse(response, errorMessage = 'API request failed') {
            if (!response.ok) {
                // Try to get error details from response
                let errorDetails = '';
                try {
                    const errorData = await response.json();
                    errorDetails = errorData.error || errorData.message || '';
                } catch (e) {
                    // Ignore JSON parsing errors for error responses
                }
                
                const error = new Error(`${errorMessage}${errorDetails ? ': ' + errorDetails : ''}`);
                error.status = response.status;
                throw error;
            }
            
            return response;
        }

        async function fetchEntries() {
            try {
                const response = await fetchWithAuth('/entries');
                if (!response.ok) throw new Error('Failed to fetch entries');
                
                const entries = await response.json();
                allEntries = entries;
                return entries;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to load entries');
                console.error('Error fetching entries:', error);
                return [];
            }
        }

        async function fetchEntry(id) {
            try {
                const response = await fetchWithAuth(`/entries/${id}`);
                if (!response.ok) throw new Error('Failed to fetch entry');
                
                const entry = await response.json();
                currentEntry = entry;
                return entry;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to load entry');
                console.error('Error fetching entry:', error);
                return null;
            }
        }

        async function saveEntry(entry) {
            try {
                const method = entry.id ? 'PUT' : 'POST';
                const url = entry.id ? `/entries/${entry.id}` : '/entries';
                
                const response = await fetchWithAuth(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
                
                if (!response.ok) throw new Error('Failed to save entry');
                
                const data = await response.json();
                showNotification('success', 'Success', entry.id ? 'Entry updated successfully' : 'Entry added successfully');
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to save entry');
                console.error('Error saving entry:', error);
                throw error;
            }
        }

        async function deleteEntry(id) {
            try {
                const response = await fetchWithAuth(`/entries/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete entry');
                
                showNotification('success', 'Success', 'Entry deleted successfully');
                
                if (currentPage === 'entries') {
                    loadPage('entries');
                } else if (currentPage === 'entry-detail') {
                    loadPage('entries');
                }
                
                return true;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to delete entry');
                console.error('Error deleting entry:', error);
                return false;
            }
        }

        async function uploadImage(entryId, file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetchWithAuth(`/entries/${entryId}/images`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload image');
                
                const data = await response.json();
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to upload image');
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        async function uploadVoiceNote(entryId, blob, duration) {
            try {
                const formData = new FormData();
                formData.append('voice', blob, 'voice-note.webm');
                formData.append('duration', duration);
                
                const response = await fetchWithAuth(`/entries/${entryId}/voice`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload voice note');
                
                const data = await response.json();
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to upload voice note');
                console.error('Error uploading voice note:', error);
                throw error;
            }
        }

        async function deleteFile(fileId) {
            try {
                const response = await fetchWithAuth(`/files/${fileId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete file');
                
                const data = await response.json();
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to delete file');
                console.error('Error deleting file:', error);
                throw error;
            }
        }

        async function fetchTags() {
            try {
                const response = await fetchWithAuth('/tags');
                if (!response.ok) throw new Error('Failed to fetch tags');
                
                const tags = await response.json();
                allTags = tags;
                return tags;
            } catch (error) {
                console.error('Error fetching tags:', error);
                return [];
            }
        }

        async function searchEntries(query, tags, mood, startDate, endDate) {
            try {
                let url = '/entries/search?';
                
                if (query) url += `q=${encodeURIComponent(query)}&`;
                if (tags && tags.length) {
                    tags.forEach(tag => {
                        url += `tags=${encodeURIComponent(tag)}&`;
                    });
                }
                if (mood) url += `mood=${encodeURIComponent(mood)}&`;
                if (startDate) url += `start_date=${encodeURIComponent(startDate)}&`;
                if (endDate) url += `end_date=${encodeURIComponent(endDate)}&`;
                
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to search entries');
                
                const entries = await response.json();
                return entries;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to search entries');
                console.error('Error searching entries:', error);
                return [];
            }
        }

        async function fetchStats() {
            try {
                const response = await fetchWithAuth('/stats');
                if (!response.ok) throw new Error('Failed to fetch statistics');
                
                const stats = await response.json();
                return stats;
            } catch (error) {
                console.error('Error fetching statistics:', error);
                return null;
            }
        }

        async function incrementVisitors() {
            try {
                await fetchWithAuth('/visitors/increment', { method: 'POST' });
                updateVisitorCount();
            } catch (error) {
                console.error('Error incrementing visitors:', error);
            }
        }

        async function updateVisitorCount() {
            try {
                const response = await fetchWithAuth('/visitors');
                if (!response.ok) throw new Error('Failed to fetch visitor count');
                
                const data = await response.json();
                visitorCount.textContent = data.count.toLocaleString();
            } catch (error) {
                console.error('Error fetching visitor count:', error);
            }
        }

        async function fetchSettings() {
            try {
                const response = await fetchWithAuth('/settings');
                if (!response.ok) throw new Error('Failed to fetch settings');
                
                const settings = await response.json();
                appSettings = settings;
                applySettings(settings);
                return settings;
            } catch (error) {
                console.error('Error fetching settings:', error);
                return null;
            }
        }

        async function updateSettings(settings) {
            try {
                const response = await fetchWithAuth('/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) throw new Error('Failed to update settings');
                
                const data = await response.json();
                appSettings = { ...appSettings, ...settings };
                applySettings(appSettings);
                showNotification('success', 'Success', 'Settings updated successfully');
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to update settings');
                console.error('Error updating settings:', error);
                throw error;
            }
        }

        async function uploadBackground(file) {
            try {
                const formData = new FormData();
                formData.append('background', file);
                
                const response = await fetchWithAuth('/settings/background', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload background');
                
                const data = await response.json();
                showNotification('success', 'Success', 'Background uploaded successfully');
                return data;
            } catch (error) {
                showNotification('error', 'Error', 'Failed to upload background');
                console.error('Error uploading background:', error);
                throw error;
            }
        }

        // UI Functions
        function debugLog(message, data = null) {
            if (localStorage.getItem('debugMode') === 'true') {
                if (data) {
                    console.log(`[DEBUG] ${message}:`, data);
                } else {
                    console.log(`[DEBUG] ${message}`);
                }
            }
        }
        
        // Function to retry failed operations
        async function retryOperation(operation, maxRetries = 3, delay = 1000) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await operation();
                } catch (error) {
                    lastError = error;
                    debugLog(`Operation failed (attempt ${attempt}/${maxRetries}):`, error);
                    
                    if (attempt < maxRetries) {
                        // Wait before next retry
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // Increase delay for next attempt (exponential backoff)
                        delay *= 2;
                    }
                }
            }
            
            throw lastError;
        }
        
        // Function to validate entry data before saving
        function validateEntryData(entry) {
            const errors = [];
            
            if (!entry.date) errors.push('Date is required');
            if (!entry.content || entry.content.trim() === '') errors.push('Content is required');
            
            // Validate tags (if present)
            if (entry.tags && Array.isArray(entry.tags)) {
                entry.tags = entry.tags.filter(tag => tag && typeof tag === 'string' && tag.trim() !== '');
            } else {
                entry.tags = [];
            }
            
            return {
                valid: errors.length === 0,
                errors
            };
        }
        
        // Function to clean up memory leaks
        function cleanupResources() {
                    
            // Clean up audio
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
            
            // Clean up media recorder
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                } catch (e) {
                    console.error('Error cleaning up media recorder:', e);
                }
            }
            
            // Clear any intervals or timeouts
            if (window.recordingInterval) {
                clearInterval(window.recordingInterval);
                window.recordingInterval = null;
            }
        }
        
        // Window unload event to clean up resources
        window.addEventListener('beforeunload', cleanupResources);
        
        // Improved error handling for page navigation
        function loadPage(page, params = {}) {
            try {
                // Clean up resources from previous page
                cleanupResources();
                
                currentPage = page;
                pageTitle.textContent = getPageTitle(page);
                
                // Show/hide FAB button based on page
                if (page === 'entries' || page === 'tags' || page === 'search') {
                    newEntryFab.classList.remove('hidden');
                } else {
                    newEntryFab.classList.add('hidden');
                }
                
                // Load page content
                switch (page) {
                    case 'new-entry':
                        loadNewEntry();
                        break;
                    case 'entry-detail':
                        loadEntryDetail(params.id);
                        break;
                    case 'tags':
                        loadTags();
                        break;
                    case 'search':
                        loadSearch();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                    default:
                        loadEntries();
                }
            } catch (error) {
                console.error('Error loading page:', error);
                showNotification('error', 'Error', `Failed to load ${page} page`);
                if (page !== 'entries') {
                    loadEntries()
                }
            }
        }

        function getPageTitle(page) {
            switch (page) {
                case 'entries': return 'All Entries';
                case 'new-entry': return 'New Entry';
                case 'entry-detail': return 'Entry Details';
                case 'tags': return 'Tags';
                case 'search': return 'Search';
                case 'settings': return 'Settings';
                default: return 'Entries';
            }
        }

        
        

        async function loadEntries() {
            showLoading();
            appContent.innerHTML = `
                <div class="entries-header">
                    <div class="filter-container">
                        <select id="moodFilter" class="filter-select">
                            <option value="">All Moods</option>
                            <option value="Happy">Happy</option>
                            <option value="Sad">Sad</option>
                            <option value="Excited">Excited</option>
                            <option value="Calm">Calm</option>
                            <option value="Anxious">Anxious</option>
                            <option value="Grateful">Grateful</option>
                            <option value="Frustrated">Frustrated</option>
                            <option value="Inspired">Inspired</option>
                        </select>
                        <select id="mediaFilter" class="filter-select">
                            <option value="">All Entries</option>
                            <option value="images">With Images</option>
                            <option value="voice">With Voice Notes</option>
                        </select>
                    </div>
                    <div class="view-toggle">
                        <button id="gridViewBtn" class="view-toggle-btn active">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="listViewBtn" class="view-toggle-btn">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <div id="entriesContainer" class="entries-grid">
                    <div class="text-center mt-4 mb-4 text-muted">Loading entries...</div>
                </div>
            `;
            
            try {
                // Set up view toggle
                const gridViewBtn = document.getElementById('gridViewBtn');
                const listViewBtn = document.getElementById('listViewBtn');
                const entriesContainer = document.getElementById('entriesContainer');
                
                gridViewBtn.addEventListener('click', () => {
                    gridViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    entriesContainer.className = 'entries-grid';
                });
                
                listViewBtn.addEventListener('click', () => {
                    listViewBtn.classList.add('active');
                    gridViewBtn.classList.remove('active');
                    entriesContainer.className = 'entries-list';
                });
                
                // Set up filters
                const moodFilter = document.getElementById('moodFilter');
                const mediaFilter = document.getElementById('mediaFilter');
                
                const handleFilter = () => {
                    const moodValue = moodFilter.value;
                    const mediaValue = mediaFilter.value;
                    
                    let filteredEntries = [...allEntries];
                    
                    if (moodValue) {
                        filteredEntries = filteredEntries.filter(entry => entry.mood === moodValue);
                    }
                    
                    if (mediaValue === 'images') {
                        filteredEntries = filteredEntries.filter(entry => entry.has_images);
                    } else if (mediaValue === 'voice') {
                        filteredEntries = filteredEntries.filter(entry => entry.has_voice);
                    }
                    
                    renderEntries(filteredEntries);
                };
                
                moodFilter.addEventListener('change', handleFilter);
                mediaFilter.addEventListener('change', handleFilter);
                
                // Fetch and render entries
                const entries = await fetchEntries();
                renderEntries(entries);
            } catch (error) {
                console.error('Error loading entries:', error);
                showNotification('error', 'Error', 'Failed to load entries');
            } finally {
                hideLoading();
            }
        }
        
        function renderEntries(entries) {
            const entriesContainer = document.getElementById('entriesContainer');
            entriesContainer.innerHTML = '';
            
            if (entries.length === 0) {
                entriesContainer.innerHTML = `
                    <div class="text-center mt-4 mb-4 text-muted">
                        No entries found. <a href="#" onclick="loadPage('new-entry')">Create a new entry</a>.
                    </div>
                `;
                return;
            }
            
            const viewMode = entriesContainer.classList.contains('entries-grid') ? 'grid' : 'list';
            
            entries.forEach(entry => {
                entriesContainer.appendChild(createEntryElement(entry, viewMode));
            });
        }
        function createEntryElement(entry, viewMode = 'grid') {
    const div = document.createElement('div');
    div.className = viewMode === 'grid' ? 'entry-card' : 'entry-card entry-card-list';
    
    // Add background styling if entry has a custom background
    if (entry.background) {
        if (!entry.background.startsWith('#')) {
            // Image background
            div.classList.add('has-background');
            const timestamp = Date.now();
            div.style.backgroundImage = `url(${API_URL}/files/${entry.background}?auth=${authToken}&t=${timestamp})`;
            div.style.backgroundSize = 'cover';
            div.style.backgroundPosition = 'center';
            
            // Add overlay for better text readability
            const overlay = document.createElement('div');
            overlay.className = 'entry-card-overlay';
            div.appendChild(overlay);
        } else {
            // For color backgrounds, just set the background color
            div.style.backgroundColor = entry.background;
        }
    }
    
    const innerDiv = document.createElement('div');
    innerDiv.className = 'entry-card-inner';
    
    innerDiv.innerHTML = `
        <div class="entry-header">
            <div class="entry-date">
                <i class="fas fa-calendar"></i>
                ${entry.date}
            </div>
            <div class="entry-actions">
                <button class="entry-action-btn edit" onclick="editEntry('${entry.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="entry-action-btn delete" onclick="confirmDeleteEntry('${entry.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="entry-content">${entry.content}</div>
        <div class="entry-footer">
            <div class="entry-tags">
                ${entry.tags && entry.tags.length > 0 ? entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('') : ''}
            </div>
            <div class="entry-indicators">
                ${entry.mood ? `<div class="entry-indicator"><i class="fas fa-smile"></i> ${entry.mood}</div>` : ''}
                ${entry.has_images ? `<div class="entry-indicator"><i class="fas fa-image"></i></div>` : ''}
                ${entry.has_voice ? `<div class="entry-indicator"><i class="fas fa-microphone"></i></div>` : ''}
            </div>
        </div>
    `;
    
    div.appendChild(innerDiv);
    
    // Make the whole card clickable to view entry details
    div.addEventListener('click', (e) => {
        // Don't navigate if clicking on action buttons
        if (!e.target.closest('.entry-actions')) {
            loadPage('entry-detail', { id: entry.id });
        }
    });
    
    return div;
}
        
        function filterEntries(searchText) {
            const filteredEntries = allEntries.filter(entry => {
                const content = entry.content.toLowerCase();
                const date = entry.date.toLowerCase();
                const tags = entry.tags ? entry.tags.join(' ').toLowerCase() : '';
                const mood = entry.mood ? entry.mood.toLowerCase() : '';
                const location = entry.location ? entry.location.toLowerCase() : '';
                
                return content.includes(searchText) || 
                       date.includes(searchText) || 
                       tags.includes(searchText) || 
                       mood.includes(searchText) || 
                       location.includes(searchText);
            });
            
            renderEntries(filteredEntries);
        }
        
        function createEntryHTML(entry) {
            const timestamp = Date.now();
            
            let html = `<div class="entry-card" data-id="${entry.id}">`;
            
            // Add background styling if entry has a custom background
            if (entry.background) {
                if (entry.background.startsWith('#')) {
                    // Color background
                    html += `<div class="entry-card-inner" style="background-color: ${entry.background};">`;
                } else {
                    // Image background
                    html += `
                        <div class="entry-card-overlay"></div>
                        <div class="entry-card-inner" style="background-image: url(${API_URL}/files/${entry.background}?auth=${authToken}&t=${timestamp});">
                    `;
                    html = html.replace('<div class="entry-card"', '<div class="entry-card has-background"');
                }
            } else {
                html += `<div class="entry-card-inner">`;
            }
            
            html += `
                    <div class="entry-header">
                        <div class="entry-date">
                            <i class="fas fa-calendar"></i>
                            ${entry.date}
                        </div>
                        <div class="entry-actions">
                            <button class="entry-action-btn edit" onclick="event.stopPropagation(); editEntry('${entry.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="entry-action-btn delete" onclick="event.stopPropagation(); confirmDeleteEntry('${entry.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="entry-content">${entry.content}</div>
                    <div class="entry-footer">
                        <div class="entry-tags">
                            ${entry.tags && entry.tags.length > 0 ? entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('') : ''}
                        </div>
                        <div class="entry-indicators">
                            ${entry.mood ? `<div class="entry-indicator"><i class="fas fa-smile"></i> ${entry.mood}</div>` : ''}
                            ${entry.has_images ? `<div class="entry-indicator"><i class="fas fa-image"></i></div>` : ''}
                            ${entry.has_voice ? `<div class="entry-indicator"><i class="fas fa-microphone"></i></div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            return html;
        }

        async function loadEntryDetail(id) {
            showLoading();
            appContent.innerHTML = `
                <div class="text-center mt-4 mb-4">
                    <div class="spinner"></div>
                    <p class="mt-2 text-muted">Loading entry...</p>
                </div>
            `;
            
            try {
                const entry = await fetchEntry(id);
                if (!entry) {
                    appContent.innerHTML = `
                        <div class="text-center mt-4 mb-4 text-muted">
                            Entry not found. <a href="#" onclick="loadPage('entries')">Back to entries</a>.
                        </div>
                    `;
                    return;
                }
                
                currentEntryId = entry.id;
                
                // Create entry detail HTML
                let entryDetailHTML = `
                    <div class="entry-detail">
                        <div class="entry-detail-header">
                            <div>
                                <h2 class="entry-detail-title">${entry.date}</h2>
                                <div class="entry-detail-meta">
                                    ${entry.mood ? `<div class="entry-detail-meta-item"><i class="fas fa-smile"></i> ${entry.mood}</div>` : ''}
                                    ${entry.location ? `<div class="entry-detail-meta-item"><i class="fas fa-map-marker-alt"></i> ${entry.location}</div>` : ''}
                                    ${entry.weather ? `<div class="entry-detail-meta-item"><i class="fas fa-cloud-sun"></i> ${entry.weather}</div>` : ''}
                                </div>
                            </div>
                            <div class="entry-detail-actions">
                                <button class="entry-detail-action" onclick="editEntry('${entry.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="entry-detail-action danger" onclick="confirmDeleteEntry('${entry.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="entry-detail-content">
                            <div class="entry-detail-text">${entry.content}</div>
                            
                            ${entry.tags && entry.tags.length > 0 ? `
                                <div class="entry-tags mb-3">
                                    ${entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                `;
                
                // Add images section if entry has images
                if (entry.has_images && entry.images && entry.images.length > 0) {
                    entryDetailHTML += `
                        <div class="entry-media-section">
                            <h3 class="entry-media-title"><i class="fas fa-images"></i> Images</h3>
                            <div class="entry-images">
                                ${entry.images.map((image, index) => `
                                    <div class="entry-image">
                                        <img src="${API_URL}/files/${image.id}" 
                                             alt="Entry image" 
                                             onclick="viewImage('${image.id}', ${index})"
                                             onerror="this.onerror=null; this.src='https://via.placeholder.com/200x200?text=Image+Error'; this.parentNode.classList.add('image-error');">
                                        <div class="entry-image-actions">
                                            <button class="entry-image-action" onclick="event.stopPropagation(); downloadFile('${image.id}', '${image.filename}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="entry-image-action" onclick="event.stopPropagation(); deleteFileWithConfirm('${image.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    // Set up image gallery for the viewer
                    imageGallery = entry.images.map(image => ({
                        id: image.id,
                        url: `${API_URL}/files/${image.id}`
                    }));
                }
                
                // Add voice notes section if entry has voice notes
                if (entry.has_voice && entry.voice_notes && entry.voice_notes.length > 0) {
                    entryDetailHTML += `
                        <div class="entry-media-section">
                            <h3 class="entry-media-title"><i class="fas fa-microphone"></i> Voice Notes</h3>
                            <div class="entry-voice-notes">
                                ${entry.voice_notes.map(voice => `
                                    <div class="voice-note">
                                        <button class="voice-note-play" onclick="playVoiceNote('${voice.id}', this)">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <div class="voice-note-info">
                                            <div class="voice-note-title">Voice Note</div>
                                            <div class="voice-note-duration">${formatDuration(voice.duration || 0)}</div>
                                        </div>
                                        <div class="voice-note-actions">
                                            <button class="voice-note-action" onclick="downloadFile('${voice.id}', '${voice.filename}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="voice-note-action delete" onclick="deleteFileWithConfirm('${voice.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                entryDetailHTML += `
                        </div>
                    </div>
                    <div class="mb-4">
                        <button class="btn btn-secondary" onclick="loadPage('entries')">
                            <i class="fas fa-arrow-left"></i> Back to Entries
                        </button>
                    </div>
                `;
                
                appContent.innerHTML = entryDetailHTML;
            } catch (error) {
                console.error('Error loading entry detail:', error);
                showNotification('error', 'Error', 'Failed to load entry details');
                appContent.innerHTML = `
                    <div class="text-center mt-4 mb-4 text-muted">
                        Error loading entry. <a href="#" onclick="loadPage('entries')">Back to entries</a>.
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        async function loadNewEntry(editId = null) {
            showLoading();
            
            let entryToEdit = null;
            if (editId) {
                try {
                    entryToEdit = await fetchEntry(editId);
                    if (!entryToEdit) {
                        showNotification('error', 'Error', 'Entry not found');
                        loadPage('entries');
                        return;
                    }
                    currentEntryId = editId;
                } catch (error) {
                    console.error('Error fetching entry to edit:', error);
                    showNotification('error', 'Error', 'Failed to load entry for editing');
                    loadPage('entries');
                    return;
                }
            }
            
            // Reset uploaded media arrays
            uploadedImages = [];
            uploadedVoiceNotes = [];
            
            appContent.innerHTML = `
                <div class="editor-container">
                    <div class="editor-header">
                        <h2 class="editor-title">${editId ? 'Edit Entry' : 'New Entry'}</h2>
                    </div>
                    <div class="editor-content">
                        <form id="entryForm" class="editor-form">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="text" id="entryDate" class="form-input" placeholder="Date" value="${entryToEdit ? entryToEdit.date : getCurrentDateString()}" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Content</label>
                                <div id="richEditor" class="rich-editor"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Mood</label>
                                <select id="entryMood" class="form-input">
                                    <option value="">Select Mood</option>
                                    <option value="Happy">Happy</option>
                                    <option value="Sad">Sad</option>
                                    <option value="Excited">Excited</option>
                                    <option value="Calm">Calm</option>
                                    <option value="Anxious">Anxious</option>
                                    <option value="Grateful">Grateful</option>
                                    <option value="Frustrated">Frustrated</option>
                                    <option value="Inspired">Inspired</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" id="entryLocation" class="form-input" placeholder="Where are you?" value="${entryToEdit && entryToEdit.location ? entryToEdit.location : ''}">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Weather</label>
                                <input type="text" id="entryWeather" class="form-input" placeholder="How's the weather?" value="${entryToEdit && entryToEdit.weather ? entryToEdit.weather : ''}">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <div class="tag-input-container" id="tagContainer">
                                    <input type="text" id="tagInput" class="tag-input" placeholder="Add tags...">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Images</label>
                                <div class="media-upload-container">
                                    <div class="media-upload-dropzone" id="imageDropzone">
                                        <div class="media-upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <div class="media-upload-text">Drag images here or click to upload</div>
                                        <div class="media-upload-hint">Max 10MB per image, supports JPG, PNG, GIF</div>
                                    </div>
                                    <div class="media-preview" id="imagePreview"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Voice Notes</label>
                                <div class="voice-recorder" id="voiceRecorder">
                                    <button type="button" class="voice-recorder-btn" id="recordButton">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <div class="voice-recorder-timer" id="recordingTimer">00:00</div>
                                    <div class="voice-recorder-status" id="recordingStatus">
                                        Click to start recording a voice note
                                    </div>
                                </div>
                                <div class="media-preview" id="voicePreview"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entry Style (Optional)</label>
                                <div class="entry-customization">
                                    <div class="color-option" style="background-color: transparent; border: 1px dashed #ccc;" data-color="none">No Style</div>
                                    <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                                    <div class="color-option" style="background-color: #f0f8ff;" data-color="#f0f8ff"></div>
                                    <div class="color-option" style="background-color: #f0fff0;" data-color="#f0fff0"></div>
                                    <div class="color-option" style="background-color: #fff0f5;" data-color="#fff0f5"></div>
                                    <div class="color-option" style="background-color: #f5f5dc;" data-color="#f5f5dc"></div>
                                    <div class="color-option" style="background-color: #ffe4e1;" data-color="#ffe4e1"></div>
                                    <div class="color-option" style="background-color: #e6e6fa;" data-color="#e6e6fa"></div>
                                    <div class="color-option" style="background-color: #ffdab9;" data-color="#ffdab9"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="flex justify-between mt-4 mb-4">
                    <button class="btn btn-secondary" onclick="loadPage('${editId ? 'entry-detail' : 'entries'}', ${editId ? `{ id: '${editId}' }` : '{}'})">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" id="saveEntryBtn">
                        <i class="fas fa-save"></i> ${editId ? 'Update Entry' : 'Save Entry'}
                    </button>
                </div>
            `;
            
            // Initialize rich text editor
            const quill = new Quill('#richEditor', {
                theme: 'snow',
                placeholder: 'Start writing your diary entry...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
            
            // Set content if editing
            if (entryToEdit) {
                quill.root.innerHTML = entryToEdit.content;
                
                // Set mood if present
                if (entryToEdit.mood) {
                    document.getElementById('entryMood').value = entryToEdit.mood;
                                }
                
                // Set background color if present
                if (entryToEdit.background && entryToEdit.background.startsWith('#')) {
                    const colorOptions = document.querySelectorAll('.color-option');
                    colorOptions.forEach(option => {
                        if (option.dataset.color === entryToEdit.background) {
                            option.classList.add('selected');
                        }
                    });
                }
                
                // Set tags if present
                if (entryToEdit.tags && entryToEdit.tags.length > 0) {
                    const tagContainer = document.getElementById('tagContainer');
                    const tagInput = document.getElementById('tagInput');
                    
                    entryToEdit.tags.forEach(tag => {
                        const tagElement = createTagElement(tag);
                        tagContainer.insertBefore(tagElement, tagInput);
                    });
                }
                
                // Display existing images if any
                if (entryToEdit.has_images && entryToEdit.images && entryToEdit.images.length > 0) {
                    const imagePreview = document.getElementById('imagePreview');
                    
                    entryToEdit.images.forEach(image => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item';
                        previewItem.innerHTML = `
                            <img src="${API_URL}/files/${image.id}" alt="Image preview">
                            <button class="media-preview-remove" data-id="${image.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagePreview.appendChild(previewItem);
                        
                        // Store the image info for saving
                        uploadedImages.push({
                            id: image.id,
                            filename: image.filename,
                            existing: true
                        });
                    });
                    
                    // Add event listeners to remove buttons
                    imagePreview.querySelectorAll('.media-preview-remove').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const imageId = e.currentTarget.dataset.id;
                            const index = uploadedImages.findIndex(img => img.id === imageId);
                            
                            if (index !== -1) {
                                uploadedImages.splice(index, 1);
                            }
                            
                            e.currentTarget.parentElement.remove();
                        });
                    });
                }
                
                // Display existing voice notes if any
                if (entryToEdit.has_voice && entryToEdit.voice_notes && entryToEdit.voice_notes.length > 0) {
                    const voicePreview = document.getElementById('voicePreview');
                    
                    entryToEdit.voice_notes.forEach(voice => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item media-preview-audio';
                        previewItem.innerHTML = `
                            <div class="media-preview-audio-icon">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <div class="voice-note-duration">${formatDuration(voice.duration || 0)}</div>
                            <button class="media-preview-remove" data-id="${voice.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        voicePreview.appendChild(previewItem);
                        
                        // Store the voice note info for saving
                        uploadedVoiceNotes.push({
                            id: voice.id,
                            filename: voice.filename,
                            duration: voice.duration || 0,
                            existing: true
                        });
                    });
                    
                    // Add event listeners to remove buttons
                    voicePreview.querySelectorAll('.media-preview-remove').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const voiceId = e.currentTarget.dataset.id;
                            const index = uploadedVoiceNotes.findIndex(voice => voice.id === voiceId);
                            
                            if (index !== -1) {
                                uploadedVoiceNotes.splice(index, 1);
                            }
                            
                            e.currentTarget.parentElement.remove();
                        });
                    });
                }
            } else {
                // Set default background for new entry
                document.querySelector('.color-option[data-color="#ffffff"]').classList.add('selected');
            }
            
            // Set up tags input
            setupTagsInput();
            
            // Set up image upload
            setupImageUpload();
            
            // Set up voice recorder
            setupVoiceRecorder();
            
            // Set up color options
            setupColorOptions();
            
            // Handle form submission
            document.getElementById('saveEntryBtn').addEventListener('click', async () => {
                const content = quill.root.innerHTML;
                const date = document.getElementById('entryDate').value;
                const mood = document.getElementById('entryMood').value;
                const location = document.getElementById('entryLocation').value;
                const weather = document.getElementById('entryWeather').value;
                
                // Get tags
                const tags = [];
                document.querySelectorAll('.tag-item').forEach(tag => {
                    tags.push(tag.dataset.value);
                });
                
                // Get selected background color
                const selectedColor = document.querySelector('.color-option.selected');
                const background = selectedColor && selectedColor.dataset.color !== 'none' 
                    ? selectedColor.dataset.color 
                    : null;  // Set to null instead of default white
                
                if (!content.trim()) {
                    showNotification('error', 'Error', 'Please enter some content for your entry');
                    return;
                }
                
                try {
                    showLoading();
                    
                    // Create or update the entry
                    const entryData = {
                        date,
                        content,
                        mood,
                        location,
                        weather,
                        tags,
                        background  // This will be null if "No Style" is selected
                    };
                    
                    if (editId) {
                        entryData.id = editId;
                    }
                    
                    const response = await saveEntry(entryData);
                    
                    // Get the entry ID (either from the response or the existing ID)
                    const entryId = response.id || editId;
                    
                    // Upload any new images
                    const newImages = uploadedImages.filter(img => !img.existing);
                    for (const image of newImages) {
                        await uploadImage(entryId, image.file);
                    }
                    
                    // Upload any new voice notes
                    const newVoiceNotes = uploadedVoiceNotes.filter(voice => !voice.existing);
                    for (const voice of newVoiceNotes) {
                        await uploadVoiceNote(entryId, voice.blob, voice.duration);
                    }
                    
                    // Navigate to the entry detail page
                    loadPage('entry-detail', { id: entryId });
                } catch (error) {
                    console.error('Error saving entry:', error);
                    showNotification('error', 'Error', 'Failed to save entry');
                } finally {
                    hideLoading();
                }
            });
            
            hideLoading();
        }
        
        function setupTagsInput() {
            const tagContainer = document.getElementById('tagContainer');
            const tagInput = document.getElementById('tagInput');
            
            // Create a tag element
            function createTagElement(value) {
                const tag = document.createElement('div');
                tag.className = 'tag-item';
                tag.dataset.value = value;
                tag.innerHTML = `
                    ${value}
                    <button class="tag-remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add event listener to remove button
                tag.querySelector('.tag-remove').addEventListener('click', () => {
                    tag.remove();
                });
                
                return tag;
            }
            
            // Add tag when pressing Enter
            tagInput.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    
                    const value = tagInput.value.trim();
                    if (value) {
                        // Check if tag already exists
                        const existingTags = Array.from(tagContainer.querySelectorAll('.tag-item')).map(tag => tag.dataset.value);
                        if (!existingTags.includes(value)) {
                            const tag = createTagElement(value);
                            tagContainer.insertBefore(tag, tagInput);
                            tagInput.value = '';
                        } else {
                            showNotification('warning', 'Warning', 'Tag already exists');
                        }
                    }
                }
            });
            
            // Fetch tags for autocomplete
            fetchTags().then(tags => {
                if (tags && tags.length > 0) {
                    // Create tag suggestions
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'tag-suggestions';
                    tagContainer.parentNode.appendChild(suggestionsDiv);
                    
                    // Show suggestions when typing
                    tagInput.addEventListener('input', () => {
                        const value = tagInput.value.trim().toLowerCase();
                        if (value) {
                            const matchingTags = tags.filter(tag => 
                                tag.toLowerCase().includes(value) && 
                                !Array.from(tagContainer.querySelectorAll('.tag-item')).map(t => t.dataset.value.toLowerCase()).includes(tag.toLowerCase())
                            );
                            
                            if (matchingTags.length > 0) {
                                suggestionsDiv.innerHTML = matchingTags.map(tag => `<div class="tag-suggestion">${tag}</div>`).join('');
                                suggestionsDiv.style.display = 'block';
                                
                                // Add event listeners to suggestions
                                suggestionsDiv.querySelectorAll('.tag-suggestion').forEach(suggestion => {
                                    suggestion.addEventListener('click', () => {
                                        const tag = createTagElement(suggestion.textContent);
                                        tagContainer.insertBefore(tag, tagInput);
                                        tagInput.value = '';
                                        suggestionsDiv.style.display = 'none';
                                    });
                                });
                            } else {
                                suggestionsDiv.style.display = 'none';
                            }
                        } else {
                            suggestionsDiv.style.display = 'none';
                        }
                    });
                    
                    // Hide suggestions when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.tag-input-container') && !e.target.closest('.tag-suggestions')) {
                            suggestionsDiv.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        function setupImageUpload() {
            const imageDropzone = document.getElementById('imageDropzone');
            const imagePreview = document.getElementById('imagePreview');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            // Handle click on dropzone
            imageDropzone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', handleFiles);
            
            // Handle drag and drop
            imageDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageDropzone.classList.add('active');
            });
            
            imageDropzone.addEventListener('dragleave', () => {
                imageDropzone.classList.remove('active');
            });
            
            imageDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                imageDropzone.classList.remove('active');
                if (e.dataTransfer.files.length) {
                    handleFiles({ target: { files: e.dataTransfer.files } });
                }
            });
            
            function handleFiles(e) {
                const files = Array.from(e.target.files);
                
                files.forEach(file => {
                    // Check file type
                    if (!file.type.startsWith('image/')) {
                        showNotification('error', 'Error', `${file.name} is not an image file`);
                        return;
                    }
                    
                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        showNotification('error', 'Error', `${file.name} exceeds the 10MB size limit`);
                        return;
                    }
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="Image preview">
                            <button class="media-preview-remove">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagePreview.appendChild(previewItem);
                        
                        // Store the file for later upload
                        const imageId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        uploadedImages.push({
                            id: imageId,
                            file,
                            filename: file.name
                        });
                        
                        // Add event listener to remove button
                        previewItem.querySelector('.media-preview-remove').addEventListener('click', () => {
                            const index = uploadedImages.findIndex(img => img.id === imageId);
                            if (index !== -1) {
                                uploadedImages.splice(index, 1);
                            }
                            previewItem.remove();
                        });
                    };
                    reader.readAsDataURL(file);
                });
                
                // Reset file input
                fileInput.value = '';
            }
        }
        
        function setupVoiceRecorder() {
            const recordButton = document.getElementById('recordButton');
            const recordingTimer = document.getElementById('recordingTimer');
            const recordingStatus = document.getElementById('recordingStatus');
            const voicePreview = document.getElementById('voicePreview');
            
            if (!recordButton || !recordingTimer || !recordingStatus || !voicePreview) {
                console.error('Voice recorder elements not found');
                return;
            }
            
            // Check if browser supports audio recording
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                recordingStatus.textContent = 'Audio recording not supported in this browser';
                recordButton.disabled = true;
                return;
            }
            
            let recordingInterval = null;
            
            recordButton.addEventListener('click', toggleRecording);
            
            async function toggleRecording() {
                if (isRecording) {
                    // Stop recording
                    stopRecording();
                } else {
                    // Start recording
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        startRecording(stream);
                    } catch (error) {
                        console.error('Error accessing microphone:', error);
                        recordingStatus.textContent = 'Error accessing microphone. Please check permissions.';
                        showNotification('error', 'Error', 'Could not access microphone');
                    }
                }
            }
            
            function startRecording(stream) {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.addEventListener('dataavailable', (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    // Create audio blob
                    const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    
                    // Create audio element for preview
                    const audioURL = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioURL);
                    
                    // Create preview item
                    const previewItem = document.createElement('div');
                    previewItem.className = 'media-preview-item media-preview-audio';
                    previewItem.innerHTML = `
                        <div class="media-preview-audio-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <div class="voice-note-duration">${formatDuration(recordingDuration)}</div>
                        <button class="media-preview-remove">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    voicePreview.appendChild(previewItem);
                    
                    // Store the recording for later upload
                    const voiceId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    uploadedVoiceNotes.push({
                        id: voiceId,
                        blob: audioBlob,
                        duration: recordingDuration,
                        url: audioURL
                    });
                    
                    // Add event listener to remove button
                    previewItem.querySelector('.media-preview-remove').addEventListener('click', () => {
                        const index = uploadedVoiceNotes.findIndex(voice => voice.id === voiceId);
                        if (index !== -1) {
                            uploadedVoiceNotes.splice(index, 1);
                        }
                        previewItem.remove();
                    });
                    
                    // Reset UI
                    recordButton.classList.remove('recording');
                    recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    recordingStatus.textContent = 'Voice note recorded';
                    
                    // Stop all tracks
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                });
                
                // Start recording
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                recordButton.classList.add('recording');
                recordButton.innerHTML = '<i class="fas fa-stop"></i>';
                recordingStatus.textContent = 'Recording... Click to stop';
                
                // Start timer
                recordingDuration = 0;
                recordingTimer.textContent = '00:00';
                recordingTimer.style.display = 'block';
                
                // Clear any existing interval
                if (recordingInterval) clearInterval(recordingInterval);
                
                recordingInterval = setInterval(() => {
                    recordingDuration++;
                    const minutes = Math.floor(recordingDuration / 60);
                    const seconds = recordingDuration % 60;
                    recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Limit recording to 5 minutes
                    if (recordingDuration >= 300) {
                        stopRecording();
                    }
                }, 1000);
            }
            
            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    // Clear timer interval
                    if (recordingInterval) {
                        clearInterval(recordingInterval);
                        recordingInterval = null;
                    }
                }
            }
        }
        
        function setupColorOptions() {
            const colorOptions = document.querySelectorAll('.color-option');
            
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                });
            });
        }

        async function loadTags() {
            showLoading();
            appContent.innerHTML = `
                <div class="text-center mt-4 mb-4">
                    <div class="spinner"></div>
                    <p class="mt-2 text-muted">Loading tags...</p>
                </div>
            `;
            
            try {
                const tags = await fetchTags();
                
                if (tags.length === 0) {
                    appContent.innerHTML = `
                        <div class="text-center mt-4 mb-4 text-muted">
                            No tags found. Tags will appear here when you add them to your entries.
                        </div>
                    `;
                    return;
                }
                
                // Group entries by tag
                const taggedEntries = {};
                const entries = await fetchEntries();
                
                tags.forEach(tag => {
                    taggedEntries[tag] = entries.filter(entry => 
                        entry.tags && entry.tags.includes(tag)
                    );
                });
                
                // Render tags page
                let html = `
                    <div class="entries-header">
                        <h2>Browse by Tag</h2>
                    </div>
                    
                    <div class="tag-cloud mb-4">
                `;
                
                // Create tag cloud
                tags.forEach(tag => {
                    const count = taggedEntries[tag].length;
                    const size = Math.max(1, Math.min(2, 0.8 + (count / 10))); // Scale between 0.8 and 2 based on count
                    
                    html += `
                        <a href="#tag-${tag}" class="tag-cloud-item" style="font-size: ${size}em;">
                            ${tag} <span class="tag-count">(${count})</span>
                        </a>
                    `;
                });
                
                html += `
                    </div>
                `;
                
                // Create sections for each tag
                tags.forEach(tag => {
                    const entries = taggedEntries[tag];
                    
                    html += `
                        <div id="tag-${tag}" class="tag-section mb-4">
                            <h3 class="tag-section-title mb-3">
                                <i class="fas fa-tag"></i> ${tag}
                                <span class="tag-count">(${entries.length} entries)</span>
                            </h3>
                            
                            <div class="entries-grid">
                                ${entries.map(entry => createEntryHTML(entry)).join('')}
                            </div>
                        </div>
                    `;
                });
                
                appContent.innerHTML = html;
                
                // Add event listeners to entry cards
                document.querySelectorAll('.entry-card').forEach(card => {
                    const id = card.dataset.id;
                    
                    card.addEventListener('click', (e) => {
                        // Don't navigate if clicking on action buttons
                        if (!e.target.closest('.entry-actions')) {
                            loadPage('entry-detail', { id });
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading tags:', error);
                showNotification('error', 'Error', 'Failed to load tags');
                appContent.innerHTML = `
                    <div class="text-center mt-4 mb-4 text-muted">
                        Error loading tags. Please try again later.
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }
        
        function createEntryHTML(entry) {
            let html = `
                <div class="entry-card" data-id="${entry.id}">
            `;
            
            // Add background styling if entry has a custom background
            if (entry.background) {
                if (entry.background.startsWith('#')) {
                    // Color background
                    html += `<div class="entry-card-inner" style="background-color: ${entry.background};">`;
                } else {
                    // Image background
                    html += `
                        <div class="entry-card-overlay"></div>
                        <div class="entry-card-inner" style="background-image: url(${API_URL}/files/${entry.background});">
                    `;
                }
            } else {
                html += `<div class="entry-card-inner">`;
            }
            
            html += `
                    <div class="entry-header">
                        <div class="entry-date">
                            <i class="fas fa-calendar"></i>
                            ${entry.date}
                        </div>
                        <div class="entry-actions">
                            <button class="entry-action-btn edit" onclick="event.stopPropagation(); editEntry('${entry.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="entry-action-btn delete" onclick="event.stopPropagation(); confirmDeleteEntry('${entry.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="entry-content">${entry.content}</div>
                    <div class="entry-footer">
                        <div class="entry-tags">
                            ${entry.tags && entry.tags.length > 0 ? entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('') : ''}
                        </div>
                        <div class="entry-indicators">
                            ${entry.mood ? `<div class="entry-indicator"><i class="fas fa-smile"></i> ${entry.mood}</div>` : ''}
                            ${entry.has_images ? `<div class="entry-indicator"><i class="fas fa-image"></i></div>` : ''}
                            ${entry.has_voice ? `<div class="entry-indicator"><i class="fas fa-microphone"></i></div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            return html;
        }

        async function loadSearch() {
            appContent.innerHTML = `
                <div class="editor-container">
                    <div class="editor-header">
                        <h2 class="editor-title">Advanced Search</h2>
                    </div>
                    <div class="editor-content">
                        <form id="searchForm" class="editor-form">
                            <div class="form-group">
                                <label class="form-label">Search Text</label>
                                <input type="text" id="searchQuery" class="form-input" placeholder="Search in content, location...">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <div class="tag-input-container" id="searchTagContainer">
                                    <input type="text" id="searchTagInput" class="tag-input" placeholder="Add tags to search...">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Mood</label>
                                <select id="searchMood" class="form-input">
                                    <option value="">Any Mood</option>
                                    <option value="Happy">Happy</option>
                                    <option value="Sad">Sad</option>
                                    <option value="Excited">Excited</option>
                                    <option value="Calm">Calm</option>
                                    <option value="Anxious">Anxious</option>
                                    <option value="Grateful">Grateful</option>
                                    <option value="Frustrated">Frustrated</option>
                                    <option value="Inspired">Inspired</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <div class="flex gap-2">
                                    <input type="date" id="searchStartDate" class="form-input" placeholder="From">
                                    <input type="date" id="searchEndDate" class="form-input" placeholder="To">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="searchResults" class="mt-4"></div>
            `;
            
            // Set up tags input for search
            const tagContainer = document.getElementById('searchTagContainer');
            const tagInput = document.getElementById('searchTagInput');
            
            // Fetch tags for autocomplete
            const tags = await fetchTags();
            
            // Add tag when pressing Enter
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    
                    const value = tagInput.value.trim();
                    if (value) {
                        // Check if tag already exists
                        const existingTags = Array.from(tagContainer.querySelectorAll('.tag-item')).map(tag => tag.dataset.value);
                        if (!existingTags.includes(value)) {
                            const tag = document.createElement('div');
                            tag.className = 'tag-item';
                            tag.dataset.value = value;
                            tag.innerHTML = `
                                ${value}
                                <button class="tag-remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            
                            // Add event listener to remove button
                            tag.querySelector('.tag-remove').addEventListener('click', () => {
                                tag.remove();
                            });
                            
                            tagContainer.insertBefore(tag, tagInput);
                            tagInput.value = '';
                        }
                    }
                }
            });
            
            // Create tag suggestions if we have tags
            if (tags && tags.length > 0) {
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.className = 'tag-suggestions';
                tagContainer.parentNode.appendChild(suggestionsDiv);
                
                // Show suggestions when typing
                tagInput.addEventListener('input', () => {
                    const value = tagInput.value.trim().toLowerCase();
                    if (value) {
                        const matchingTags = tags.filter(tag => 
                            tag.toLowerCase().includes(value) && 
                            !Array.from(tagContainer.querySelectorAll('.tag-item')).map(t => t.dataset.value.toLowerCase()).includes(tag.toLowerCase())
                        );
                        
                        if (matchingTags.length > 0) {
                            suggestionsDiv.innerHTML = matchingTags.map(tag => `<div class="tag-suggestion">${tag}</div>`).join('');
                            suggestionsDiv.style.display = 'block';
                            
                            // Add event listeners to suggestions
                            suggestionsDiv.querySelectorAll('.tag-suggestion').forEach(suggestion => {
                                suggestion.addEventListener('click', () => {
                                    const tag = document.createElement('div');
                                    tag.className = 'tag-item';
                                    tag.dataset.value = suggestion.textContent;
                                    tag.innerHTML = `
                                        ${suggestion.textContent}
                                        <button class="tag-remove">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    `;
                                    
                                    // Add event listener to remove button
                                    tag.querySelector('.tag-remove').addEventListener('click', () => {
                                        tag.remove();
                                    });
                                    
                                    tagContainer.insertBefore(tag, tagInput);
                                    tagInput.value = '';
                                    suggestionsDiv.style.display = 'none';
                                });
                            });
                        } else {
                            suggestionsDiv.style.display = 'none';
                        }
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                });
                
                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                                        if (!e.target.closest('.tag-input-container') && !e.target.closest('.tag-suggestions')) {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }
            
            // Handle search form submission
            document.getElementById('searchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const query = document.getElementById('searchQuery').value.trim();
                const mood = document.getElementById('searchMood').value;
                const startDate = document.getElementById('searchStartDate').value;
                const endDate = document.getElementById('searchEndDate').value;
                
                // Get selected tags
                const selectedTags = [];
                document.querySelectorAll('#searchTagContainer .tag-item').forEach(tag => {
                    selectedTags.push(tag.dataset.value);
                });
                
                // Show loading
                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = `
                    <div class="text-center mt-4 mb-4">
                        <div class="spinner"></div>
                        <p class="mt-2 text-muted">Searching...</p>
                    </div>
                `;
                
                try {
                    // Execute search
                    const results = await searchEntries(query, selectedTags, mood, startDate, endDate);
                    
                    if (results.length === 0) {
                        searchResults.innerHTML = `
                            <div class="text-center mt-4 mb-4 text-muted">
                                No entries found matching your criteria.
                            </div>
                        `;
                        return;
                    }
                    
                    // Display results
                    searchResults.innerHTML = `
                        <h3 class="mb-3">Search Results (${results.length} entries found)</h3>
                        <div class="entries-grid" id="resultsGrid"></div>
                    `;
                    
                    const resultsGrid = document.getElementById('resultsGrid');
                    
                    results.forEach(entry => {
                        resultsGrid.appendChild(createEntryElement(entry));
                    });
                } catch (error) {
                    console.error('Error searching entries:', error);
                    searchResults.innerHTML = `
                        <div class="text-center mt-4 mb-4 text-danger">
                            Error searching entries. Please try again.
                        </div>
                    `;
                }
            });
        }

        async function loadSettings() {
            showLoading();
            appContent.innerHTML = `
                <div class="settings-section">
                    <div class="settings-header">
                        <h2 class="settings-title">Appearance Settings</h2>
                    </div>
                    <div class="settings-content">
                        <div class="settings-group">
                            <h3 class="settings-group-title">Theme</h3>
                            <div class="settings-row">
                                <div class="settings-label">Select Theme</div>
                                <div class="theme-options">
                                    <div class="theme-option" data-theme="light">
                                        <div class="theme-preview theme-preview-light">
                                            <div class="theme-preview-inner"></div>
                                        </div>
                                        <span>Light</span>
                                    </div>
                                    <div class="theme-option" data-theme="dark">
                                        <div class="theme-preview theme-preview-dark">
                                            <div class="theme-preview-inner"></div>
                                        </div>
                                        <span>Dark</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h3 class="settings-group-title">Font</h3>
                            <div class="settings-row">
                                <div class="settings-label">Font Family</div>
                                <select id="fontFamily" class="font-select">
                                    <option value="Inter, sans-serif">Inter (Default)</option>
                                    <option value="Merriweather, serif">Merriweather</option>
                                    <option value="Montserrat, sans-serif">Montserrat</option>
                                    <option value="Lora, serif">Lora</option>
                                    <option value="Roboto, sans-serif">Roboto</option>
                                </select>
                            </div>
                            <div class="settings-row">
                                <div class="settings-label">Font Size</div>
                                <div class="font-size-options">
                                    <div class="font-size-option" data-size="small">Small</div>
                                    <div class="font-size-option" data-size="medium">Medium</div>
                                    <div class="font-size-option" data-size="large">Large</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h3 class="settings-group-title">Colors</h3>
                            <div class="settings-row">
                                <div class="settings-label">Accent Color</div>
                                <div class="color-picker">
                                    <div class="color-option" style="background-color: #2563eb;" data-color="#2563eb"></div>
                                    <div class="color-option" style="background-color: #10b981;" data-color="#10b981"></div>
                                    <div class="color-option" style="background-color: #ef4444;" data-color="#ef4444"></div>
                                    <div class="color-option" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                                    <div class="color-option" style="background-color: #8b5cf6;" data-color="#8b5cf6"></div>
                                    <div class="color-option" style="background-color: #ec4899;" data-color="#ec4899"></div>
                                    <input type="color" id="customAccentColor" class="custom-color-input" value="#2563eb">
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h3 class="settings-group-title">Background</h3>
                            <div class="settings-row">
                                <div class="settings-label">App Background</div>
                            </div>
                            <div class="background-options">
                                <div class="custom-bg-option selected" data-type="color" data-value="#fafafa" style="background-color: #fafafa;"></div>
                                <div class="custom-bg-option" data-type="color" data-value="#f0f8ff" style="background-color: #f0f8ff;"></div>
                                <div class="custom-bg-option" data-type="color" data-value="#f0fff0" style="background-color: #f0fff0;"></div>
                                <div class="custom-bg-option" data-type="color" data-value="#fff0f5" style="background-color: #fff0f5;"></div>
                                <div class="custom-bg-option" data-type="color" data-value="#f5f5dc" style="background-color: #f5f5dc;"></div>
                                <div class="custom-bg-option" data-type="pattern" data-value="pattern1">
                                    <img src="https://www.transparenttextures.com/patterns/cubes.png" alt="Pattern">
                                </div>
                                <div class="custom-bg-option" data-type="pattern" data-value="pattern2">
                                    <img src="https://www.transparenttextures.com/patterns/diamond-upholstery.png" alt="Pattern">
                                </div>
                                <div class="custom-bg-option" data-type="pattern" data-value="pattern3">
                                    <img src="https://www.transparenttextures.com/patterns/subtle-white-feathers.png" alt="Pattern">
                                </div>
                                <div class="custom-bg-option custom-bg-upload" id="bgUploadOption">
                                    <div class="custom-bg-upload-icon">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div class="custom-bg-upload-text">Upload Custom</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section mt-4">
                    <div class="settings-header">
                        <h2 class="settings-title">Account</h2>
                    </div>
                    <div class="settings-content">
                        <div class="settings-group">
                            <h3 class="settings-group-title">Authentication</h3>
                            <div class="settings-row">
                                <div class="settings-label">Change Authentication Code</div>
                                <button id="changeAuthBtn" class="btn btn-secondary">
                                    <i class="fas fa-key"></i> Change Code
                                </button>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h3 class="settings-group-title">Data</h3>
                            <div class="settings-row">
                                <div class="settings-label">Export All Entries</div>
                                <button id="exportDataBtn" class="btn btn-secondary">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 mb-4">
                    <button id="saveSettingsBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            `;
            
            // Fetch current settings
            const settings = await fetchSettings();
            
            // Apply current settings to UI
            if (settings) {
                // Set theme option
                document.querySelector(`.theme-option[data-theme="${settings.theme}"]`).classList.add('selected');
                
                // Set font family
                document.getElementById('fontFamily').value = settings.font_family;
                
                // Set font size
                document.querySelector(`.font-size-option[data-size="${settings.font_size}"]`).classList.add('selected');
                
                // Set accent color
                const accentColor = settings.accent_color || '#2563eb';
                document.querySelector(`.color-option[data-color="${accentColor}"]`)?.classList.add('selected');
                document.getElementById('customAccentColor').value = accentColor;
                
                // Set background
                if (settings.background_type && settings.background_value) {
                    const bgOption = document.querySelector(`.custom-bg-option[data-type="${settings.background_type}"][data-value="${settings.background_value}"]`);
                    if (bgOption) {
                        document.querySelectorAll('.custom-bg-option').forEach(opt => opt.classList.remove('selected'));
                        bgOption.classList.add('selected');
                    }
                }
            }
            
            // Set up event listeners
            
            // Theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // Font size options
            document.querySelectorAll('.font-size-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.font-size-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // Accent color options
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // Custom accent color input
            document.getElementById('customAccentColor').addEventListener('input', (e) => {
                const color = e.target.value;
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            });
            
            // Background options
            document.querySelectorAll('.custom-bg-option').forEach(option => {
                if (!option.id || option.id !== 'bgUploadOption') {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.custom-bg-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                }
            });
            
            // Background upload
            const bgUploadOption = document.getElementById('bgUploadOption');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            bgUploadOption.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files.length) {
                    const file = e.target.files[0];
                    
                    // Check file size
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('error', 'Error', 'Background image must be less than 5MB');
                        return;
                    }
                    
                    try {
                        showLoading();
                        const result = await uploadBackground(file);
                        
                        // Create a new background option with the uploaded image
                        const newOption = document.createElement('div');
                        newOption.className = 'custom-bg-option';
                        newOption.dataset.type = 'image';
                        newOption.dataset.value = result.background_id;
                        
                        // Create a thumbnail preview
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            newOption.style.backgroundImage = `url(${e.target.result})`;
                            newOption.style.backgroundSize = 'cover';
                            newOption.style.backgroundPosition = 'center';
                            
                            // Insert before the upload option
                            document.querySelectorAll('.custom-bg-option').forEach(opt => opt.classList.remove('selected'));
                            newOption.classList.add('selected');
                            bgUploadOption.parentNode.insertBefore(newOption, bgUploadOption);
                            
                            // Add click event
                            newOption.addEventListener('click', () => {
                                document.querySelectorAll('.custom-bg-option').forEach(opt => opt.classList.remove('selected'));
                                newOption.classList.add('selected');
                            });
                        };
                        reader.readAsDataURL(file);
                        
                        showNotification('success', 'Success', 'Background uploaded successfully');
                    } catch (error) {
                        showNotification('error', 'Error', 'Failed to upload background');
                    } finally {
                        hideLoading();
                    }
                }
            });
            
            // Save settings button
            document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
                try {
                    showLoading();
                    
                    // Get selected theme
                    const selectedTheme = document.querySelector('.theme-option.selected').dataset.theme;
                    
                    // Get selected font family
                    const fontFamily = document.getElementById('fontFamily').value;
                    
                    // Get selected font size
                    const fontSize = document.querySelector('.font-size-option.selected').dataset.size;

                                        
                    // Get selected accent color
                    let accentColor;
                    const selectedColorOption = document.querySelector('.color-option.selected');
                    if (selectedColorOption) {
                        accentColor = selectedColorOption.dataset.color;
                    } else {
                        accentColor = document.getElementById('customAccentColor').value;
                    }
                    
                    // Get selected background
                    const selectedBg = document.querySelector('.custom-bg-option.selected');
                    const backgroundType = selectedBg.dataset.type;
                    const backgroundValue = selectedBg.dataset.value;
                    
                    // Create settings object
                    const newSettings = {
                        theme: selectedTheme,
                        font_family: fontFamily,
                        font_size: fontSize,
                        accent_color: accentColor,
                        background_type: backgroundType,
                        background_value: backgroundValue
                    };
                    
                    // Update settings
                    await updateSettings(newSettings);
                    
                    // Update theme
                    theme = selectedTheme;
                    document.documentElement.setAttribute('data-theme', theme);
                    updateThemeIcon();
                    
                    showNotification('success', 'Success', 'Settings saved successfully');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showNotification('error', 'Error', 'Failed to save settings');
                } finally {
                    hideLoading();
                }
            });
            
            // Change auth code button
            document.getElementById('changeAuthBtn').addEventListener('click', () => {
                // Implement auth code change functionality
                // This would typically open a modal where the user can enter their current code
                // and set a new one
                showNotification('info', 'Info', 'This feature is not implemented in the demo');
            });
            
            // Export data button
            document.getElementById('exportDataBtn').addEventListener('click', async () => {
                try {
                    showLoading();
                    
                    // Fetch all entries
                    const entries = await fetchEntries();
                    
                    // Format data for export
                    const exportData = {
                        entries: entries,
                        exportDate: new Date().toISOString(),
                        totalEntries: entries.length
                    };
                    
                    // Create a downloadable JSON file
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `diary-export-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('success', 'Success', 'Data exported successfully');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    showNotification('error', 'Error', 'Failed to export data');
                } finally {
                    hideLoading();
                }
            });
            
            hideLoading();
        }

        function toggleTheme() {
            theme = theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeIcon();
            
            // Reset any custom background to allow theme background to show
            document.body.style.backgroundColor = '';
            document.body.style.backgroundImage = '';
            document.body.classList.remove('custom-bg-image', 'custom-bg-pattern');
            
            // Update settings if logged in
            if (authToken) {
                updateSettings({ theme }).catch(err => {
                    console.error('Error updating theme setting:', err);
                });
            }
        }

        function getCurrentDateString() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return now.toLocaleDateString('en-US', options);
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme) {
                theme = settings.theme;
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeIcon();
            }
            
            // Apply font family
            if (settings.font_family) {
                document.documentElement.style.setProperty('--font-family', settings.font_family);
            }
            
            // Apply font size
            if (settings.font_size) {
                let fontSize = '16px';
                switch (settings.font_size) {
                    case 'small': fontSize = '14px'; break;
                    case 'medium': fontSize = '16px'; break;
                    case 'large': fontSize = '18px'; break;
                }
                document.documentElement.style.setProperty('--font-size', fontSize);
            }
            
            // Apply accent color
            if (settings.accent_color) {
                document.documentElement.style.setProperty('--accent-color', settings.accent_color);
                
                // Calculate RGB values for the accent color for use in rgba()
                const hex = settings.accent_color.substring(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                document.documentElement.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);
            }
            
            // Apply background
            if (settings.background_type && settings.background_value) {
                if (settings.background_type === 'color') {
                    // Color background
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = settings.background_value;
                    document.body.classList.remove('custom-bg-image', 'custom-bg-pattern');
                } else if (settings.background_type === 'pattern') {
                    // Pattern background
                    let patternUrl = '';
                    switch (settings.background_value) {
                        case 'pattern1': patternUrl = 'https://www.transparenttextures.com/patterns/cubes.png'; break;
                        case 'pattern2': patternUrl = 'https://www.transparenttextures.com/patterns/diamond-upholstery.png'; break;
                        case 'pattern3': patternUrl = 'https://www.transparenttextures.com/patterns/subtle-white-feathers.png'; break;
                    }
                    document.body.style.backgroundImage = `url(${patternUrl})`;
                    document.body.classList.add('custom-bg-pattern');
                    document.body.classList.remove('custom-bg-image');
                } else if (settings.background_type === 'image') {
                    // Image background
                    document.body.style.backgroundImage = `url(${API_URL}/files/${settings.background_value})`;
                    document.body.classList.add('custom-bg-image');
                    document.body.classList.remove('custom-bg-pattern');
                    document.querySelector('.bg-overlay').style.display = 'block';
                }
            }
        }

        // UI Utilities
        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function showNotification(type, title, message, duration = 5000) {
            // Prevent XSS by sanitizing inputs
            const sanitize = (str) => {
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            };
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${sanitize(type)}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${getNotificationIcon(type)}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${sanitize(title)}</div>
                    <div class="notification-message">${sanitize(message)}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Get or create notification container
            let notificationContainer = document.getElementById('notificationContainer');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notificationContainer';
                notificationContainer.className = 'notification-container';
                document.body.appendChild(notificationContainer);
            }
            
            notificationContainer.appendChild(notification);
            
            // Add event listener to close button
            notification.querySelector('.notification-close').addEventListener('click', () => {
                closeNotification(notification);
            });
            
            // Automatically close after duration
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNotification(notification);
                }
            }, duration);
            
            return notification;
        }

        function closeNotification(notification) {
            notification.classList.add('closing');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-info-circle';
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                // Reset form if it exists
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // Clear error messages
                const errorElements = modal.querySelectorAll('.auth-error, .error-message');
                errorElements.forEach(el => el.style.display = 'none');
            }, 300);
        }
        
      function elementExists(id) {
          return document.getElementById(id) !== null;
        }

        // Image Viewer Functions
        function viewImage(imageId, index) {
            currentImageIndex = index;
            const viewer = document.getElementById('imageViewer');
            const viewerImage = document.getElementById('viewerImage');
            
            // Show loading state
            viewerImage.src = '';
            viewerImage.style.display = 'none';
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'spinner';
            loadingSpinner.id = 'imageViewerSpinner';
            viewer.querySelector('.image-viewer-content').appendChild(loadingSpinner);
            
            // Show the viewer
            viewer.style.display = 'flex';
            setTimeout(() => viewer.classList.add('active'), 10);
            
            // Fetch the image with auth headers
            fetch(`${API_URL}/files/${imageId}`, {
                headers: {
                    'X-Auth-Code': authToken
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to load image');
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                viewerImage.onload = () => {
                    // Remove spinner and show image
                    const spinner = document.getElementById('imageViewerSpinner');
                    if (spinner) spinner.remove();
                    viewerImage.style.display = 'block';
                };
                viewerImage.src = url;
            })
            .catch(error => {
                console.error('Error loading image:', error);
                // Remove spinner and show error message
                const spinner = document.getElementById('imageViewerSpinner');
                if (spinner) spinner.remove();
                
                viewerImage.src = 'https://via.placeholder.com/400x300?text=Image+Loading+Error';
                viewerImage.style.display = 'block';
                showNotification('error', 'Error', 'Failed to load image');
            });
        }


        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                viewer.style.display = 'none';
            }, 300);
        }

        function nextImage() {
            if (imageGallery.length <= 1) return;
            
            currentImageIndex = (currentImageIndex + 1) % imageGallery.length;
            document.getElementById('viewerImage').src = imageGallery[currentImageIndex].url;
        }

        function prevImage() {
            if (imageGallery.length <= 1) return;
            
            currentImageIndex = (currentImageIndex - 1 + imageGallery.length) % imageGallery.length;
            document.getElementById('viewerImage').src = imageGallery[currentImageIndex].url;
        }

        // Action Functions
        function editEntry(id) {
            loadNewEntry(id);
        }

        function confirmDeleteEntry(id) {
            currentEntryId = id;
            openModal('deleteModal');
        }

        function playVoiceNote(voiceId, button) {
          // Stop any currently playing audio
          const currentAudio = window.currentAudio;
          if (currentAudio) {
              currentAudio.pause();
              // Reset any playing buttons
              document.querySelectorAll('.voice-note-play').forEach(btn => {
                  btn.innerHTML = '<i class="fas fa-play"></i>';
              });
          }
          
          try {
              // Create an audio element with auth headers
              const audio = new Audio();
              
              // Add auth headers to the request
              fetch(`${API_URL}/files/${voiceId}`, {
                  headers: {
                      'X-Auth-Code': authToken
                  }
              })
              .then(response => {
                  if (!response.ok) throw new Error('Failed to load audio');
                  return response.blob();
              })
              .then(blob => {
                  const url = URL.createObjectURL(blob);
                  audio.src = url;
                  
                  // Change button icon to pause
                  button.innerHTML = '<i class="fas fa-pause"></i>';
                  
                  // Play the audio
                  audio.play().catch(err => {
                      console.error('Error playing audio:', err);
                      button.innerHTML = '<i class="fas fa-play"></i>';
                      showNotification('error', 'Error', 'Failed to play voice note');
                  });
                  
                  // Store the current audio globally
                  window.currentAudio = audio;
                  
                  // Add ended event listener
                  audio.addEventListener('ended', () => {
                      button.innerHTML = '<i class="fas fa-play"></i>';
                      window.currentAudio = null;
                  });
                  
                  // Add click event to pause/resume
                  button.onclick = (e) => {
                      e.stopPropagation();
                      if (audio.paused) {
                          audio.play();
                          button.innerHTML = '<i class="fas fa-pause"></i>';
                      } else {
                          audio.pause();
                          button.innerHTML = '<i class="fas fa-play"></i>';
                      }
                  };
              })
              .catch(error => {
                  console.error('Error loading voice note:', error);
                  showNotification('error', 'Error', 'Failed to load voice note');
                  button.innerHTML = '<i class="fas fa-play"></i>';
              });
          } catch (error) {
              console.error('Error playing voice note:', error);
              showNotification('error', 'Error', 'Failed to play voice note');
              button.innerHTML = '<i class="fas fa-play"></i>';
          }
      }

      function downloadFile(fileId, filename) {
            showLoading();
            
            fetch(`${API_URL}/files/${fileId}`, {
                headers: {
                    'X-Auth-Code': authToken
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to download file');
                return response.blob();
            })
            .then(blob => {
                hideLoading();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'download';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            })
            .catch(error => {
                hideLoading();
                console.error('Error downloading file:', error);
                showNotification('error', 'Error', 'Failed to download file');
            });
        }

        // Tag element creation helper
        function createTagElement(value) {
            const tag = document.createElement('div');
            tag.className = 'tag-item';
            tag.dataset.value = value;
            tag.innerHTML = `
                ${value}
                <button class="tag-remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add event listener to remove button
            tag.querySelector('.tag-remove').addEventListener('click', () => {
                tag.remove();
            });
            
            return tag;
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape key closes modals and image viewer
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    const modalId = activeModal.id;
                    closeModal(modalId);
                }
                
                const imageViewer = document.getElementById('imageViewer');
                if (imageViewer.classList.contains('active')) {
                    closeImageViewer();
                }
            }
            
            // Arrow keys for image navigation
            if (document.getElementById('imageViewer').classList.contains('active')) {
                if (e.key === 'ArrowRight') {
                    nextImage();
                } else if (e.key === 'ArrowLeft') {
                    prevImage();
                }
            }
            
            // Ctrl+S to save entry when in editor
            if (e.ctrlKey && e.key === 's' && currentPage === 'new-entry') {
                e.preventDefault();
                document.getElementById('saveEntryBtn').click();
            }
        });
    </script>
</body>
</html>
